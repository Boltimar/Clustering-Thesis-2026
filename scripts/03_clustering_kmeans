# -------------------------------------------------------------------------
# Masterarbeit: Unüberwachte Baumartenklassifizierung
# Skript 03: K-Means Clustering
# Autor: Christian Salzmann (2026)
# -------------------------------------------------------------------------

# --- Schritt 1: R-Pakete installieren und laden ---
# Stelle sicher, dass diese Pakete installiert sind. Falls nicht, entferne das Kommentarzeichen (#) und führe die Zeile aus.
# install.packages("terra")
# install.packages("sf")
# install.packages("stats")
# install.packages("ggplot2")

library(terra)
library(sf)
library(stats)
library(ggplot2)
print("Benötigte R-Pakete wurden erfolgreich geladen.")


# --- Schritt 2: Dateipfade festlegen ---
# HINWEIS FÜR GITHUB: Pfade wurden auf relative Ordner angepasst.
# Bitte das Arbeitsverzeichnis auf den Projektordner setzen.

# Wir nehmen an, die Daten liegen im Ordner "data"
raster_file <- "data/multispektral_ortho_dsm_20052025_10cm_exthermo.tif"
vector_file <- "data/Echte_BA.gpkg" 

# Wir speichern Ergebnisse im Ordner "results"
# Prüfen, ob der Ordner existiert, sonst erstellen
if(!dir.exists("results")) dir.create("results")
output_file <- "results/baumkronen_geclustert_7.gpkg"

print(paste("Raster-Datei:", raster_file))
print(paste("Vektor-Datei (Baumkronen):", vector_file))


# --- Schritt 3: Daten einlesen ---
# Multispektrales Rasterbild einlesen
print("Lese Rasterdatei ein...")
raster_data <- rast(raster_file)

# Vektordaten (Baumkronen-Polygone) einlesen
print("Lese Vektordatei ein...")
tree_crowns_sf <- st_read(vector_file)


# --- Schritt 4: Projektionen überprüfen und anpassen ---
# Es ist wichtig, dass Raster und Vektordaten dieselbe Projektion (CRS) haben.
# Falls sie unterschiedlich sind, wird das Vektor-CRS an das Raster-CRS angepasst.
if (st_crs(tree_crowns_sf) != st_crs(raster_data)) {
  print("Projektionen stimmen nicht überein. Passe die Vektordaten an die Raster-Projektion an.")
  tree_crowns_sf <- st_transform(tree_crowns_sf, crs(raster_data))
}


# --- Schritt 5: Spektrale Mittelwerte für jede Baumkrone berechnen ---
# Wir verwenden die Funktion 'extract' aus dem 'terra'-Paket, um die Pixelwerte 
# innerhalb jedes Polygons zu extrahieren und direkt den Mittelwert zu berechnen.
print("Extrahiere Pixelwerte und berechne die Mittelwerte pro Baumkrone...")
# Die Funktion 'fun=mean' berechnet den Mittelwert für jede Spalte (jedes Band).
mean_values <- extract(raster_data, tree_crowns_sf, fun=mean)


# --- Schritt 6: K-Means-Clustering durchführen ---
# Wir verwenden die berechneten Mittelwerte als Input für den K-Means-Algorithmus.
# 'k' ist die Anzahl der gewünschten Cluster. Hier ist sie auf 7 festgelegt.
# 'nstart=25' wird empfohlen, um ein besseres Ergebnis zu erzielen, indem der Algorithmus 25 mal mit unterschiedlichen Startpunkten läuft.
print("Führe K-Means-Clustering mit den Mittelwerten durch...")
set.seed(42) # Für reproduzierbare Ergebnisse
# Hinweis: Wir nutzen mean_values[, -1], um die erste Spalte (ID) auszuschließen
kmeans_result <- kmeans(mean_values[, -1], centers = 7, nstart = 25)

# Das Ergebnis 'kmeans_result' enthält die Cluster-IDs.
# Die Spalte 'ID' in den extrahierten Daten entspricht der Reihenfolge der Polygone in der sf-Datei.
cluster_id <- kmeans_result$cluster


# --- Schritt 7: Cluster-Ergebnisse zum Vektor-Datensatz hinzufügen ---
# Füge die neu berechneten Cluster-IDs als Spalte zum sf-Objekt hinzu.
tree_crowns_clustered <- tree_crowns_sf
tree_crowns_clustered$cluster <- as.factor(cluster_id)


# --- Schritt 8: Ergebnisse in einer neuen Datei speichern ---
print("Speichere die geclusterten Baumkronen in einer neuen GPKG-Datei...")
st_write(tree_crowns_clustered, output_file, delete_layer = TRUE) # delete_layer=TRUE überschreibt die Datei, falls sie schon existiert

print("K-Means-Clustering erfolgreich abgeschlossen!")
print(paste("Die geclusterten Daten wurden unter folgendem Pfad gespeichert:", output_file))
print("Das Ergebnis ist eine neue Vektordatei, die für jede Baumkrone die zugehörige Cluster-ID enthält.")


# --- Schritt 9: Visualisierung der Ergebnisse in R ---
# Verwende ggplot2, um die geclusterten Baumkronen zu visualisieren.
print("Visualisiere die Ergebnisse in R...")
p <- ggplot(data = tree_crowns_clustered) +
  geom_sf(aes(fill = cluster)) +
  ggtitle("K-Means-Clustering der Baumkronen") +
  labs(fill = "Cluster-ID") +
  theme_minimal() +
  coord_sf(datum = NA)

# Wichtig für Skripte: Plot explizit ausgeben
print(p)
